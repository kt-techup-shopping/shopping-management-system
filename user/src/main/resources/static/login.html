<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>로그인</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin: 24px; background:#f9fafb; }
    .card { max-width: 420px; margin: 0 auto; background:#fff; border:1px solid #e5e7eb; border-radius: 12px; padding: 20px; }
    label { display:block; margin-top: 12px; font-size: 14px; color:#374151; }
    input { width:100%; padding: 10px 12px; border:1px solid #e5e7eb; border-radius:10px; margin-top: 6px; }
    button { width:100%; margin-top: 16px; padding: 12px; border-radius: 10px; border:0; background:#111827; color:#fff; font-size:16px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .muted { color:#6b7280; font-size: 13px; margin-top: 10px; }
    pre { white-space: pre-wrap; word-break: break-word; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding: 12px; margin-top: 12px; }
    .row { display:flex; gap:10px; }
    .row button { width: auto; flex:1; }
    .danger { background:#ef4444; }
  </style>
</head>
<body>
<div class="card">
  <h2 style="margin:0 0 8px;">로그인 (테스트용)</h2>
  <div class="muted">
    로그인 성공 시 accessToken을 <b>localStorage</b>에 저장합니다.
  </div>

  <label>로그인 ID</label>
  <input id="loginId" placeholder="loginId" autocomplete="username" />

  <label>비밀번호</label>
  <input id="password" type="password" placeholder="password" autocomplete="current-password" />

  <label>로그인 API 경로</label>
  <input id="loginPath" value="/api/v1/auth/login" />

  <button id="loginBtn">로그인</button>

  <div class="row">
    <button id="goPayBtn" disabled>pay.html로 이동</button>
    <button id="clearBtn" class="danger">토큰 삭제</button>
  </div>

  <div class="muted">
    저장된 토큰 키: <code>accessToken</code>
  </div>

  <pre id="debug">(로그가 여기에 표시됩니다)</pre>
</div>

<script>
  const $ = (id) => document.getElementById(id);
  const log = (msg, obj) => {
    const line = `[${new Date().toISOString()}] ${msg}` + (obj ? `\n${JSON.stringify(obj, null, 2)}` : "");
    $("debug").textContent = ($("debug").textContent === "(로그가 여기에 표시됩니다)")
      ? line
      : $("debug").textContent + "\n\n" + line;
  };

  function setPayEnabled() {
    const token = localStorage.getItem("accessToken");
    $("goPayBtn").disabled = !token;
  }

  setPayEnabled();

  $("clearBtn").addEventListener("click", () => {
    localStorage.removeItem("accessToken");
    log("accessToken 삭제 완료");
    setPayEnabled();
  });

  $("goPayBtn").addEventListener("click", () => {
    // paymentId는 수동으로 붙여서 이동하면 됨
    // 예: /api/v1/pay.html?paymentId=123
    location.href = "/api/v1/pay.html";
  });

  $("loginBtn").addEventListener("click", async () => {
    $("loginBtn").disabled = true;

    const loginId = $("loginId").value.trim();
    const password = $("password").value.trim();
    const path = $("loginPath").value.trim();

    if (!loginId || !password) {
      alert("loginId/password를 입력하세요.");
      $("loginBtn").disabled = false;
      return;
    }

    const body = { loginId, password };
    log("로그인 요청", { path, body });

    try {
      const res = await fetch(path, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body: JSON.stringify(body)
      });

      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }

      log("로그인 응답", { status: res.status, data });

      if (!res.ok) throw new Error(`로그인 실패 (HTTP ${res.status})`);

      /**
       * ✅ 여기만 네 응답에 맞게 조정하면 됨
       * 아래는 흔한 케이스들 커버:
       *  - { accessToken: "..." }
       *  - { data: { accessToken: "..." } }
       *  - { result: { accessToken: "..." } }
       */
      const accessToken =
        data?.accessToken ??
        data?.data?.accessToken ??
        data?.result?.accessToken;

      if (!accessToken) {
        throw new Error("응답에서 accessToken을 찾지 못했습니다. (필드명 확인 필요)");
      }

      localStorage.setItem("accessToken", accessToken);
      log("토큰 저장 완료", { storedKey: "accessToken", tokenPreview: accessToken.slice(0, 20) + "..." });
      setPayEnabled();
      alert("로그인 성공! 이제 pay.html에서 토큰을 사용해 API 호출할 수 있어요.");

    } catch (e) {
      log("에러", { message: e?.message, stack: e?.stack });
      alert(e?.message || "로그인 중 오류가 발생했습니다.");
    } finally {
      $("loginBtn").disabled = false;
    }
  });
</script>
</body>
</html>
