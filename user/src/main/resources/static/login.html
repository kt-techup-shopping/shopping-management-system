<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>로그인 테스트</title>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f9fafb;
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: #111827;
    }

    .container {
      width: 100%;
      max-width: 420px;
      padding: 24px;
    }

    h2 {
      margin: 0 0 12px;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
    }

    .muted {
      text-align: center;
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 18px;
      line-height: 1.45;
    }

    label {
      display: block;
      font-size: 14px;
      margin-top: 14px;
      margin-bottom: 6px;
      color: #374151;
    }

    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      font-size: 14px;
      outline: none;
      background: #fff;
    }

    input:focus {
      border-color: #c7d2fe;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .row {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    button {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      background: #111827;
      color: white;
    }

    button.secondary {
      background: #374151;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    pre {
      margin-top: 18px;
      padding: 12px;
      font-size: 12px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      max-height: 280px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.4;
    }

    .hint {
      margin-top: 10px;
      font-size: 12px;
      color: #6b7280;
      text-align: center;
    }

    code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 6px;
    }
  </style>
</head>

<body>
<div class="container">

  <h2>로그인 테스트</h2>
  <div class="muted">
    access / refresh 토큰을 <b>localStorage</b>에 저장합니다<br/>
    키: <code>accessToken</code>, <code>refreshToken</code>
  </div>

  <label>Login ID</label>
  <input id="loginId" placeholder="loginId" autocomplete="username" />

  <label>Password</label>
  <input id="password" type="password" placeholder="password" autocomplete="current-password" />

  <label>Payment ID (pay.html 이동)</label>
  <input id="paymentId" placeholder="예: 1" inputmode="numeric" />

  <div class="row">
    <button id="loginBtn">로그인</button>
    <button id="refreshBtn" class="secondary" disabled>토큰 갱신</button>
  </div>

  <div class="row">
    <button id="goPayBtn" disabled>pay.html 이동</button>
    <button id="showTokenBtn" class="secondary">토큰 상태</button>
  </div>

  <div class="hint">
    로그인 API: <code>/api/v1/auth/login</code> · 재발급 API: <code>/api/v1/auth/refresh</code>
  </div>

  <pre id="debug">(로그가 여기에 표시됩니다)</pre>

</div>

<script>
  const $ = (id) => document.getElementById(id);

  // ✅ 여기서 API 경로 고정
  const API = {
    login: "/api/v1/auth/login",
    refresh: "/api/v1/auth/refresh",
  };

  const TOKENS = {
    access: "accessToken",
    refresh: "refreshToken",
  };

  const log = (msg, obj) => {
    const el = $("debug");
    const line =
      `[${new Date().toISOString()}] ${msg}` +
      (obj ? `\n${JSON.stringify(obj, null, 2)}` : "");

    if (el.textContent === "(로그가 여기에 표시됩니다)") {
      el.textContent = line;
    } else {
      el.textContent += "\n\n" + line;
    }

    // ✅ 자동 스크롤로 최신 로그 보이게
    el.scrollTop = el.scrollHeight;
  };

  function getAccessToken() {
    return localStorage.getItem(TOKENS.access);
  }

  function getRefreshToken() {
    return localStorage.getItem(TOKENS.refresh);
  }

  function setTokens(accessToken, refreshToken) {
    if (accessToken) localStorage.setItem(TOKENS.access, accessToken);
    if (refreshToken) localStorage.setItem(TOKENS.refresh, refreshToken);
  }

  function setButtonsEnabled() {
    const hasAccess = !!getAccessToken();
    const hasRefresh = !!getRefreshToken();
    $("goPayBtn").disabled = !hasAccess;
    $("refreshBtn").disabled = !hasRefresh;
  }

  function extractTokens(data) {
    // ApiResult<LoginResponse> 형태(보통) + 여러 케이스 방어
    const accessToken =
      data?.accessToken ??
      data?.data?.accessToken ??
      data?.result?.accessToken;

    const refreshToken =
      data?.refreshToken ??
      data?.data?.refreshToken ??
      data?.result?.refreshToken;

    return { accessToken, refreshToken };
  }

  // 초기 버튼 상태
  setButtonsEnabled();

  $("showTokenBtn").addEventListener("click", () => {
    const accessToken = getAccessToken();
    const refreshToken = getRefreshToken();

    log("현재 토큰 상태", {
      hasAccessToken: !!accessToken,
      hasRefreshToken: !!refreshToken,
      accessTokenPreview: accessToken ? accessToken.slice(0, 20) + "..." : null,
      refreshTokenPreview: refreshToken ? refreshToken.slice(0, 20) + "..." : null,
    });

    setButtonsEnabled();
  });

  $("goPayBtn").addEventListener("click", () => {
    const paymentId = $("paymentId").value.trim();
    if (!paymentId) {
      log("pay.html 이동 실패: paymentId 누락");
      return;
    }

    const url = `/api/v1/pay.html?paymentId=${encodeURIComponent(paymentId)}`;
    log("pay.html로 이동", { url });
    location.href = url;
  });

  // Enter 키로 로그인 (편의)
  $("password").addEventListener("keydown", (e) => {
    if (e.key === "Enter") $("loginBtn").click();
  });

  $("loginBtn").addEventListener("click", async () => {
    $("loginBtn").disabled = true;

    const loginId = $("loginId").value.trim();
    const password = $("password").value.trim();

    if (!loginId || !password) {
      log("로그인 실패: loginId/password 누락", {
        loginIdPresent: !!loginId,
        passwordPresent: !!password
      });
      $("loginBtn").disabled = false;
      return;
    }

    const body = { loginId, password };
    log("로그인 요청", { path: API.login, body: { loginId, password: "(hidden)" } });

    try {
      const res = await fetch(API.login, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body: JSON.stringify(body)
      });

      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }

      log("로그인 응답", { status: res.status, data });

      if (!res.ok) {
        log("로그인 실패", { status: res.status });
        return;
      }

      const { accessToken, refreshToken } = extractTokens(data);
      if (!accessToken || !refreshToken) {
        log("로그인 성공했지만 토큰 파싱 실패", {
          accessTokenFound: !!accessToken,
          refreshTokenFound: !!refreshToken,
          data
        });
        return;
      }

      setTokens(accessToken, refreshToken);
      log("토큰 저장 완료", {
        storedKeys: [TOKENS.access, TOKENS.refresh],
        accessTokenPreview: accessToken.slice(0, 20) + "...",
        refreshTokenPreview: refreshToken.slice(0, 20) + "...",
      });

      setButtonsEnabled();

    } catch (e) {
      log("로그인 중 에러", { message: e?.message, stack: e?.stack });
    } finally {
      $("loginBtn").disabled = false;
    }
  });

  $("refreshBtn").addEventListener("click", async () => {
    $("refreshBtn").disabled = true;

    const refreshToken = getRefreshToken();
    if (!refreshToken) {
      log("토큰 갱신 실패: refreshToken 없음");
      setButtonsEnabled();
      return;
    }

    // RefreshTokenRequest(record) 기준: { refreshToken }
    const body = { refreshToken };
    log("토큰 갱신 요청", {
      path: API.refresh,
      body: { refreshToken: refreshToken.slice(0, 20) + "..." }
    });

    try {
      const res = await fetch(API.refresh, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body: JSON.stringify(body)
      });

      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }

      log("토큰 갱신 응답", { status: res.status, data });

      if (!res.ok) {
        log("토큰 갱신 실패", { status: res.status });
        return;
      }

      const { accessToken, refreshToken: newRefreshToken } = extractTokens(data);
      if (!accessToken || !newRefreshToken) {
        log("토큰 갱신 성공했지만 토큰 파싱 실패", {
          accessTokenFound: !!accessToken,
          refreshTokenFound: !!newRefreshToken,
          data
        });
        return;
      }

      setTokens(accessToken, newRefreshToken);
      log("토큰 갱신/저장 완료", {
        accessTokenPreview: accessToken.slice(0, 20) + "...",
        refreshTokenPreview: newRefreshToken.slice(0, 20) + "...",
      });

    } catch (e) {
      log("토큰 갱신 중 에러", { message: e?.message, stack: e?.stack });
    } finally {
      setButtonsEnabled();
    }
  });
</script>

</body>
</html>
