<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>결제하기</title>

    <!-- Toss Payments JS SDK (v2 standard) -->
    <script src="https://js.tosspayments.com/v2/standard"></script>

    <style>
        body { font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin: 24px; }
        .card { max-width: 720px; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; }
        .muted { color: #6b7280; font-size: 14px; }
        .gap { height: 10px; }
        .row { display:flex; justify-content: space-between; gap: 12px; margin: 8px 0; }
        button { width: 100%; padding: 12px 14px; border-radius: 10px; border: 0; cursor: pointer; font-size: 16px; }
        button:disabled { opacity: .5; cursor: not-allowed; }
        .primary { background: #111827; color: #fff; }
        pre { white-space: pre-wrap; word-break: break-word; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; }
        code { background:#f3f4f6; padding:2px 6px; border-radius:6px; }
    </style>
</head>

<body>
<div class="card">
    <h2 style="margin:0 0 6px;">결제 페이지 (Toss v2 Widgets)</h2>
    <div class="muted" id="subtitle">paymentId로 결제 정보를 불러오는 중...</div>

    <div class="gap"></div>

    <!-- 결제 요약 -->
    <div id="info" style="display:none;">
        <div class="row"><span class="muted">주문명</span><span id="orderName"></span></div>
        <div class="row"><span class="muted">주문 ID</span><span id="orderId"></span></div>
        <div class="row"><span class="muted">결제 금액</span><span id="amount"></span></div>
    </div>

    <div class="gap"></div>

    <!-- 할인 쿠폰 -->
    <div>
        <input type="checkbox" id="coupon-box" />
        <label for="coupon-box"> 5,000원 쿠폰 적용 </label>
    </div>

    <div class="gap"></div>

    <!-- 결제 UI -->
    <div id="payment-method"></div>

    <div class="gap"></div>

    <!-- 이용약관 UI -->
    <div id="agreement"></div>

    <div class="gap"></div>

    <!-- 결제하기 버튼 -->
    <button class="primary" id="payment-button" disabled>결제하기</button>

    <div class="gap"></div>
    <details>
        <summary class="muted">디버그</summary>
        <pre id="debug">(로그가 여기에 표시됩니다)</pre>
    </details>

    <div class="gap"></div>
    <div class="muted">
        토큰 키: <code>accessToken</code> (localStorage) / 결제정보 API: <code>/api/v1/payments/{paymentId}</code>
    </div>
</div>

<script>
    /**
     * ✅ 수정 포인트
     * 1) TOSS_CLIENT_KEY: 토스 '클라이언트 키' (v2에서 쓰는 clientKey)
     * 2) CUSTOMER_KEY: 회원 결제면 고유 customerKey (테스트면 임의 문자열 가능)
     */
    const TOSS_CLIENT_KEY = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm"
    const CUSTOMER_KEY = "test_customer_key_000001";     // 회원결제용. 비회원이면 ANONYMOUS로

    // 결제 정보 조회 API
    const PAYMENT_INFO_API_PATH = (paymentId) => `/api/v1/payments/${paymentId}`;

    const $ = (id) => document.getElementById(id);
    const debug = (msg, obj) => {
      const line = `[${new Date().toISOString()}] ${msg}` + (obj ? `\n${JSON.stringify(obj, null, 2)}` : "");
      $("debug").textContent = ($("debug").textContent === "(로그가 여기에 표시됩니다)")
        ? line
        : $("debug").textContent + "\n\n" + line;
    };

    function getPaymentIdFromQuery() {
      const params = new URLSearchParams(location.search);
      const v = params.get("paymentId");
      if (!v) return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function formatMoney(amount) {
      try { return new Intl.NumberFormat("ko-KR").format(amount) + "원"; }
      catch { return String(amount); }
    }

    function getAccessTokenOrThrow() {
      const token = localStorage.getItem("accessToken");
      if (!token) {
        // 로그인 페이지를 만들어둔 경우 여기로 보내도 됨:
        // location.href = "/api/v1/login.html";
        throw new Error("accessToken이 없습니다. 먼저 login.html에서 로그인 후 다시 시도하세요.");
      }
      return token;
    }

    async function fetchPaymentInfo(paymentId) {
      const url = PAYMENT_INFO_API_PATH(paymentId);
      const token = getAccessTokenOrThrow();

      debug("결제 정보 조회 요청", { url, auth: "Bearer <token>" });

      const res = await fetch(url, {
        method: "GET",
        headers: {
          "Accept": "application/json",
          "Authorization": `Bearer ${token}`
        }
      });

      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }

      debug("결제 정보 조회 응답", { status: res.status, data });

      if (!res.ok) throw new Error(`결제 정보 조회 실패 (HTTP ${res.status})`);

      return data;
    }

    function validateAndNormalize(payment) {
      const orderId = payment.orderId
      const amount = payment.amount
      const orderName = payment.orderName

      if (orderId == null || amount == null) {
        throw new Error("응답에 orderId/amount가 없습니다. 서버 DTO 필드명을 확인하세요.");
      }

      return { orderId: String(orderId), amount: Number(amount), orderName: String(orderName) };
    }

    function renderSummary(payload) {
      $("info").style.display = "block";
      $("orderId").textContent = payload.orderId;
      $("amount").textContent = formatMoney(payload.amount);
      $("orderName").textContent = payload.orderName;
    }

    function buildSuccessFailUrls(paymentId) {
      const origin = location.origin;
      return {
        // ✅ /api/v1 prefix 반영 + 토스가 넘겨주는 쿼리(paymentKey, orderId, amount)를 서버에서 받게 됨
        successUrl: `${origin}/api/v1/payment-success.html?paymentId=${encodeURIComponent(paymentId)}`,
        failUrl: `${origin}/api/v1/payments/toss/fail?paymentId=${encodeURIComponent(paymentId)}`
      };
    }

    async function main() {
      const paymentId = getPaymentIdFromQuery();
      if (!paymentId) {
        $("subtitle").textContent = "URL에 paymentId가 필요합니다. 예) /api/v1/pay.html?paymentId=123";
        debug("paymentId 누락", { href: location.href });
        return;
      }

      // 1) 결제 정보 조회
      $("subtitle").textContent = `paymentId=${paymentId} 결제 정보를 불러오는 중...`;
      const payment = await fetchPaymentInfo(paymentId);
      const payload = validateAndNormalize(payment.data);
      renderSummary(payload);

      // 2) 토스 위젯 초기화
      if (!TOSS_CLIENT_KEY || TOSS_CLIENT_KEY.includes("여기에_토스_클라이언트키")) {
        $("subtitle").textContent = "TOSS_CLIENT_KEY를 설정하세요.";
        debug("TOSS_CLIENT_KEY 미설정", {});
        return;
      }

      const coupon = $("coupon-box");
      const button = $("payment-button");

      const tossPayments = TossPayments(TOSS_CLIENT_KEY);

      // 회원 결제: customerKey 필요 (테스트는 임의 문자열 가능)
      // 비회원 결제라면 아래 한 줄로 바꾸면 됨:
      // const widgets = tossPayments.widgets({ customerKey: TossPayments.ANONYMOUS });
      const widgets = tossPayments.widgets({ customerKey: CUSTOMER_KEY });

      // 3) 결제 금액 설정 (서버에서 받은 amount)
      await widgets.setAmount({ currency: "KRW", value: payload.amount });

      // 4) 결제 UI 렌더링
      await Promise.all([
        widgets.renderPaymentMethods({ selector: "#payment-method", variantKey: "DEFAULT" }),
        widgets.renderAgreement({ selector: "#agreement", variantKey: "AGREEMENT" })
      ]);

      $("subtitle").textContent = "결제 수단을 선택하고 결제하기를 눌러주세요.";
      button.disabled = false;

      // 5) 쿠폰 적용(예시) - 금액 업데이트
      coupon.addEventListener("change", async function () {
        const nextAmount = coupon.checked ? Math.max(payload.amount - 5000, 0) : payload.amount;
        debug("쿠폰 변경 → 금액 업데이트", { checked: coupon.checked, nextAmount });
        await widgets.setAmount({ currency: "KRW", value: nextAmount });
      });

      // 6) 결제 요청
      button.addEventListener("click", async function () {
        button.disabled = true;

        const { successUrl, failUrl } = buildSuccessFailUrls(paymentId);

        debug("결제 요청 (widgets.requestPayment)", {
          orderId: payload.orderId,
          orderName: payload.orderName,
          successUrl,
          failUrl
        });

        try {
          await widgets.requestPayment({
            orderId: payload.orderId,       // ✅ 토스 규칙 맞는 merchantOrderId(문자열)여야 함
            orderName: payload.orderName,
            successUrl,
            failUrl
            // 필요하면 고객 정보 추가 가능:
            // customerEmail: "customer@example.com",
            // customerName: "홍길동",
            // customerMobilePhone: "01012341234",
          });
        } finally {
          // 보통은 리다이렉트로 페이지가 이동하지만, 혹시 에러로 돌아오는 케이스 대비
          button.disabled = false;
        }
      });
    }

    main().catch((e) => {
      $("subtitle").textContent = "초기화 실패";
      debug("초기화 실패", { message: e?.message, stack: e?.stack });
      alert(e?.message || "에러가 발생했습니다. 디버그 로그를 확인하세요.");
    });
</script>
</body>
</html>