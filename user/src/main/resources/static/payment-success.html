<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>결제 성공 처리</title>
</head>
<body>
<h2>결제 처리 중...</h2>

<p id="status"></p>
<p id="paymentId"></p>
<p id="paymentKey"></p>
<p id="orderId"></p>
<p id="amount"></p>

<script>
  // 1) 쿼리 파라미터 읽기 (toss successUrl → 서버 redirect → 이 페이지)
  const urlParams = new URLSearchParams(window.location.search);

  const paymentId = urlParams.get("paymentId");
  const paymentKey = urlParams.get("paymentKey");
  const orderId = urlParams.get("orderId");
  const amount = urlParams.get("amount");

  // 화면 표시 (디버깅 + 사용자 표시)
  const statusEl = document.getElementById("status");
  const paymentIdEl = document.getElementById("paymentId");
  const paymentKeyEl = document.getElementById("paymentKey");
  const orderIdEl = document.getElementById("orderId");
  const amountEl = document.getElementById("amount");

  paymentIdEl.textContent = "paymentId: " + (paymentId ?? "(없음)");
  paymentKeyEl.textContent = "paymentKey: " + (paymentKey ?? "(없음)");
  orderIdEl.textContent = "주문번호: " + (orderId ?? "(없음)");
  amountEl.textContent = "결제 금액: " + (amount ?? "(없음)");

  function redirectToFail(message, code) {
    const q = new URLSearchParams();
    if (message) q.set("message", message);
    if (code) q.set("code", code);
    window.location.href = "/payment-fail.html?" + q.toString();
  }

  function requireParams() {
    if (!paymentId || !paymentKey || !orderId || !amount) {
      statusEl.textContent = "필수 파라미터가 누락되었습니다.";
      redirectToFail("필수 파라미터 누락", "MISSING_QUERY_PARAM");
      return false;
    }
    return true;
  }

  function getAccessToken() {
    // 네가 말한 방식: 브라우저 로그인 후 localStorage에 넣어둔 accessToken 사용
    // 프로젝트에서 키 이름이 다르면 여기만 바꿔주면 됨
    return localStorage.getItem("accessToken");
  }

  async function confirmPayment() {
    if (!requireParams()) return;

    const accessToken = getAccessToken();
    if (!accessToken) {
      statusEl.textContent = "로그인이 필요합니다. (토큰 없음)";
      redirectToFail("로그인이 필요합니다.", "UNAUTHORIZED");
      return;
    }

    statusEl.textContent = "서버에 결제 승인을 요청하는 중...";

    const requestBody = {
      paymentKey,
      orderId,
      amount: Number(amount), // 서버 DTO가 Long이면 숫자로 보내는 게 안전
    };

    try {
      const response = await fetch(`/api/v1/payments/${encodeURIComponent(paymentId)}/confirm`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          // Spring Security JWT 인증 헤더
          "Authorization": `Bearer ${accessToken}`,
        },
        body: JSON.stringify(requestBody),
      });

      // 응답이 JSON이 아닐 수도 있으니 방어적으로 처리
      const text = await response.text();
      let json = null;
      try {
        json = text ? JSON.parse(text) : null;
      } catch (e) {
        // JSON 파싱 실패 시 원문을 로그
        console.log("Non-JSON response:", text);
      }

      if (!response.ok) {
        console.log("Confirm failed:", json ?? text);

        // 서버 에러 포맷이 {message, code} 라는 가정 (다르면 아래만 맞추면 됨)
        const message = json?.message ?? "결제 승인 실패";
        const code = json?.code ?? `HTTP_${response.status}`;

        statusEl.textContent = `결제 승인 실패: ${message}`;
        redirectToFail(message, code);
        return;
      }

      console.log("Confirm success:", json ?? text);

      statusEl.textContent = "결제가 정상적으로 승인되었습니다.";

      // ✅ 여기서 성공 페이지를 좀 더 예쁘게 보여주거나,
      // ✅ 결제 완료 전용 페이지로 이동해도 됨
      // 예: window.location.href = `/payment-done.html?paymentId=${paymentId}`;
    } catch (err) {
      console.error(err);
      statusEl.textContent = "네트워크 오류로 결제 승인 요청에 실패했습니다.";
      redirectToFail("네트워크 오류", "NETWORK_ERROR");
    }
  }

  // 페이지 로드 즉시 confirm 호출
  confirmPayment();
</script>
</body>
</html>
